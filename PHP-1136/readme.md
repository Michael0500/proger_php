Ниже приведён **объединённый текст** задачи, составленный на основе содержимого трёх упомянутых изображений (фото/скриншоты). Он отражает все ключевые требования и правила, которые были разобраны в ходе предыдущих шагов:

---

## 1. Общая цель

**Необходимо** создать (или доработать) систему рассылки уведомлений клиентам о скором окончании их вкладов, реализовав соответствующий модуль или сервис на Yii2.  
Система должна уметь:

1. **Ежедневно** (в определённые часы) выполнять рассылку уведомлений по списку вкладов, у которых скоро наступает дата окончания.
2. **Определять язык** уведомления (русский / английский) на основе данных из CRMSBL:
    - Если у клиента страна = «RU» или входит в список стран СНГ (AZ, AM, BY, KZ, KG, MD, TJ, UZ), то язык = «ru», иначе «en».
    - При необходимости учитывать признак резидентства (rresident / non-resident).
3. **Выбирать грамматическую форму** (единственное или множественное число) при формировании текста уведомления на основе данных из FCC:
    - Если у клиента заканчивается **1 вклад** → используем форму «singular» («У вас заканчивается вклад…» / «You have 1 deposit expiring…»).
    - Если заканчивается **несколько вкладов** → «plural» («У вас заканчиваются вклады…» / «You have N deposits expiring…»).
4. **Проверять и выбирать доступные каналы** коммуникации:
    - **SMS** (нужно корректно определить телефон клиента);
    - **E-mail** (проверить валидность адреса);
    - **EnterIMB/MCSP** (канал интернет-банка / мобильного приложения).

---

## 2. Рассылка уведомлений о вкладах

1. **Расписание отправки**: требуется настроить CRON или консольный скрипт, который будет запускаться **ежедневно** в определённом временном интервале, например с 09:00 до 11:00 (по МСК).
    - В остальное время рассылка не должна выполняться, либо должна пропускаться.
2. **Поиск вкладов**:
    - Проверять таблицу или список «active» вкладов, у которых `end_date` приближается (например, за 1–2 дня до даты окончания, либо в сам день окончания — по ТЗ).
    - Возможен вариант, когда данные о вкладах (и том, что срок подходит к концу) приходят из внешней системы FCC.
3. **Формирование текста**:
    - Система NOTIFMGR (или ваш сервис) выбирает нужный шаблон (`DEPOSIT_EXPIRING_ru_singular`, `DEPOSIT_EXPIRING_ru_plural`, `DEPOSIT_EXPIRING_en_singular`, `DEPOSIT_EXPIRING_en_plural` и т. д.) на основе:
        - **языка** (ru/en),
        - **числа** (singular/plural).
    - Динамические данные (например, `{count}` вкладов, {depositId} и т. п.) должны подставляться в шаблон.

---

## 3. Логика определения языка (CRMSBL)

По данным, полученным из системы CRMSBL, следует:

- Если страна клиента = `RU` или она в списке стран СНГ (AZ, AM, BY, KZ, KG, MD, TJ, UZ), то язык уведомления = **русский (ru)**.
- Иначе = **английский (en)**.
- (Опционально) Если есть признак «резидент» / «не резидент» (isResident), его тоже можно учитывать, например, если резидент = true → всегда `ru`. Логика конкретизируется в зависимости от ТЗ.

---

## 4. Логика определения грамматического числа (FCC)

Из FCC (или внутренней БД) приходит информация о том, **скольким вкладам** клиента требуется уведомление:

- Если вклад **один** → singular.
- Если вкладов **несколько** → plural.

Далее на основе этого выбирается соответствующий шаблон: `..._SINGULAR` или `..._PLURAL`.

---

## 5. Проверка доступных каналов

### 5.1. Приоритет телефонов (SMS)

Из Siebel (или UniCredit-системы) берутся **четыре** поля, проверяются **по приоритету**:

1. `phone_for_sms_password` (Телефон для SMS с временным паролем)
2. `mobile_phone` (Основной мобильный номер)
3. `phone_number` (Прочие телефоны клиента)
4. `phone_number_unicredit` (Может быть один или несколько номеров, «подсказка» для SMS UniCredit)

**Первый** найденный и **валидный** номер используется для SMS.  
Если ни один не найден (или все невалидные / заблокированные) → SMS-канал для клиента недоступен.

#### Нормализация номера телефона

- Удалять все лишние символы (скобки, дефисы, пробелы, точки, запятые, и т.п.), кроме `+` (если нужно).
- В итоге должны оставаться только цифры и, возможно, ведущий «+» для формата `+7…`.

#### Проверка формата

- Номер считается валидным, если удовлетворяет одному из условий (пример из ТЗ):
    - `^(\+7|7|8)9\d{9}$` (начинается на `+79`, `79`, `89` и содержит всего 11 или 12 символов),
    - либо `^9\d{9}$` (10 цифр, начинается на 9).
- Если номер не проходит эти проверки — «не валиден», переходим к следующему полю.

### 5.2. E-mail

- Проверять наличие «@» и общую корректность формата (через `FILTER_VALIDATE_EMAIL` или аналогичную логику).
- Если e-mail неверный/пустой → канал e-mail недоступен.

### 5.3. EnterIMB/MCSP

- Смотрим в поле `enterimb_status` (Подключён / Заблокирован / Не подключён).
    - Только если «Подключён» → возможно использование канала.
- Смотрим `enterimb_last_login` (дата последнего входа).
    - Если разница с текущим временем ≤ 3 дней → канал доступен.
    - Если клиент не заходил более 3 дней → канал недоступен.

В итоге может оказаться, что клиенту доступны несколько каналов (например, SMS + E-mail), либо только один, либо ни одного.

---

## 6. Поведение при рассылке

- Если каналы недоступны (нет валидного телефона, e-mail неверен, EnterIMB заблокирован и т.д.), то уведомление этому клиенту не отправляем (либо формируем исключение, логируем ситуацию и т.п.).
- Если один или несколько каналов доступны — в зависимости от бизнес-требований:
    - Отправляем **во все** доступные каналы;
    - Или только в один (самый приоритетный).

---

## 7. Дополнения

- При желании можно хранить **шаблоны уведомлений** в таблице `notification_template` (колонки `template_key`, `subject`, `body`, `language`, `plural_form` и пр.).
- Можно прикрутить систему CRON, которая каждые 30 минут (в промежутке 09:00–11:00) вызывает `php yii notify/send-deposit-expiring`.
- При использовании **NOTIFMGR** как «управляющей» подсистемы можно получать от неё ключ шаблона, дату окончания вклада, данные о клиенте (CRMSBL, FCC), затем звать ваш сервис для рассылки.
- Логику можно поместить в **модуль Yii2** (например, `modules/notifications`), внутри которого будут:
    - Модель `Client` (или несколько моделей),
    - `ChannelChecker` (проверка каналов),
    - `NotificationService` (отправка).
- Можно использовать **DI** контейнер (`Yii::$container->set(...)`) для регистрации сервисов и впоследствии забирать их в контроллерах.

---

### Итог формулировки задачи

> **«На базе трех блоков требований (расписание уведомлений о вкладах, определение языка и числа уведомления (ru/en, singular/plural) в зависимости от CRMSBL/FCC, а также проверка приоритетов телефонов, e-mail и статуса EnterIMB), реализовать в Yii2 (как модуль или сервис) функционал, позволяющий:
> 1) ежедневно в заданном интервале времени формировать и отправлять уведомления клиентам по вскоре завершающимся вкладам,
> 2) автоматически определять язык, форму (ед./мн.) и доступные каналы (SMS, e-mail, EnterIMB),
> 3) выполнять все проверки корректности номеров, формата e-mail, статуса EnterIMB (≤ 3 дней бездействия),
> 4) использовать шаблоны уведомлений (subject/body) для соответствующего языка и числа,
> 5) логировать или обрабатывать случаи отсутствия доступных каналов.  
     >  В результате должна работать полноценная рассылка с учётом всех бизнес-правил.»**